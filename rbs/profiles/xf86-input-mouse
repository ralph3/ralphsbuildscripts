#!/bin/bash

DISABLE_MULTILIB=1

VERSION="1.9.2" #1.9.2 patched to support xorg-server 1.20.0

DIR="xf86-input-mouse-${VERSION}"
TARBALL="xf86-input-mouse-${VERSION}.tar.bz2"

SRC1=(
http://xorg.freedesktop.org/releases/individual/driver/${TARBALL}
)

MD5SUMS=(
ce2d679283a22c8e0dccdd9248594845
)

build(){
  unpack_tarball $TARBALL || return 1
  cd $SRCDIR/$DIR || return 1
cat << "EOF" | patch -Np1 || return 1
diff -Naur xf86-input-mouse-1.9.2/src/mouse.c xf86-input-mouse-1.9.2.patched/src/mouse.c
--- xf86-input-mouse-1.9.2/src/mouse.c	2016-09-05 23:53:31.000000000 -0400
+++ xf86-input-mouse-1.9.2.patched/src/mouse.c	2018-06-16 06:42:25.219524001 -0400
@@ -794,7 +794,6 @@
 {
     int classes;
     int i;
-    const char *osname = NULL;
 
     if (osInfo)
         return TRUE;
@@ -821,11 +820,11 @@
                 mouseProtocols[i].id = PROT_UNSUP;
 
     /* NetBSD uses PROT_BM for "PS/2". */
-    xf86GetOS(&osname, NULL, NULL, NULL);
-    if (osname && xf86NameCmp(osname, "netbsd") == 0)
-        for (i = 0; mouseProtocols[i].name; i++)
-            if (mouseProtocols[i].id == PROT_PS2)
-                mouseProtocols[i].id = PROT_BM;
+#if defined(__NetBSD__)
+    for (i = 0; mouseProtocols[i].name; i++)
+        if (mouseProtocols[i].id == PROT_PS2)
+            mouseProtocols[i].id = PROT_BM;
+#endif
 
     return TRUE;
 }
EOF
  CC="$CC $BUILD" CXX="$CXX $BUILD" ./configure --prefix=/usr \
    --libdir=/usr/$LIBSDIR --sysconfdir=/etc --localstatedir=/var \
    --with-xorg-module-dir=/usr/$LIBSDIR/X11/modules || return 1
  make || return 1
  make install DESTDIR=$TMPROOT || return 1
  cd ../ || return 1
  rm -rf $DIR || return 1
}

version_check_info(){
  ADDRESS='http://xorg.freedesktop.org/releases/individual/driver/'
  VERSION_STRING='xf86-input-mouse-%version%.tar.bz2'
}
